<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>网易云心理 · 爱情态度光谱</title>
    
    <!-- 引入 jsPsych -->
    <script src="https://unpkg.com/jspsych@7.3.3"></script>
    <script src="https://unpkg.com/@jspsych/plugin-html-button-response@1.1.2"></script>
    <script src="https://unpkg.com/@jspsych/plugin-survey-likert@1.1.2"></script>
    <link href="https://unpkg.com/jspsych@7.3.3/css/jspsych.css" rel="stylesheet" type="text/css" />
    
    <!-- 引入 Chart.js 用于绘制雷达图 -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        /* 网易云深色系风格 */
        body {
            background-color: #161616;
            color: #f2f2f2;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-image: radial-gradient(circle at top right, #2a2a2a 0%, #161616 100%);
            margin: 0;
            min-height: 100vh;
        }
        
        .jspsych-content {
            background-color: rgba(35, 35, 35, 0.8);
            backdrop-filter: blur(20px);
            padding: 30px;
            border-radius: 16px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.5);
            max-width: 650px;
            border: 1px solid rgba(255,255,255,0.05);
        }

        /* 问卷样式 */
        .jspsych-survey-likert-statement { 
            font-size: 17px; 
            margin: 25px 0 15px 0; 
            color: #eee; 
            text-align: left;
            border-left: 4px solid #dd001b;
            padding-left: 12px;
            line-height: 1.5;
        }
        
        .jspsych-survey-likert-opts { color: #888; font-size: 13px; }
        
        /* 按钮 */
        .jspsych-btn {
            background: transparent;
            border: 1px solid #444;
            color: #ddd;
            border-radius: 50px;
            padding: 10px 30px;
            transition: 0.3s;
            font-size: 14px;
            letter-spacing: 1px;
        }
        .jspsych-btn:hover {
            border-color: #dd001b;
            color: #dd001b;
            background: rgba(221, 0, 27, 0.05);
        }

        /* 结果页组件 */
        .result-box { text-align: center; padding-top: 10px; }
        .tag {
            display: inline-block;
            background: #2b1111;
            color: #dd001b;
            padding: 4px 10px;
            border-radius: 4px;
            font-size: 12px;
            margin-bottom: 15px;
            font-weight: bold;
        }
        .main-title {
            font-size: 32px;
            font-weight: 800;
            color: #fff;
            margin-bottom: 5px;
            text-shadow: 0 2px 10px rgba(221,0,27,0.3);
        }
        .sub-title {
            font-size: 14px;
            color: #888;
            margin-bottom: 25px;
            letter-spacing: 2px;
            text-transform: uppercase;
        }
        .desc-card {
            background: #1f1f1f;
            padding: 20px;
            border-radius: 10px;
            text-align: left;
            margin-top: 20px;
            border-top: 2px solid #dd001b;
        }
        .desc-text { color: #ccc; line-height: 1.8; font-size: 15px; }
        .secondary-type {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px dashed #333;
            font-size: 13px;
            color: #666;
        }

        #jspsych-progressbar-container {
            background-color: #222 !important;
            height: 3px !important;
            bottom: 0;
            top: auto !important;
        }
        #jspsych-progressbar-inner { background-color: #dd001b !important; }
    </style>
</head>
<body></body>
<script>
    // 1. 初始化
    const jsPsych = initJsPsych({
        show_progress_bar: true,
        auto_update_progress_bar: false
    });

    const timeline = [];
    const scale = ["完全不符合", "不符合", "没意见", "符合", "完全符合"];

    // 2. 题目配置 (42题)
    const questions = [
        "我的爱人和我在第一次见面时，就立刻被彼此吸引。",
        "我试着对我的爱人保持一种不确定且模糊的承诺。",
        "很难切确的说明我和对方是何时从友情进展到爱情的。",
        "在将自己托付给对方之前，我会先仔细思考这个逐渐进入我生命的人是怎样的一个人。",
        "当我的爱人和我之间的关系发生问题时，我会感到十分不适。",
        "我会试着去付出我拥有的能力，去帮助我的爱人度过艰难的时刻。",
        "我的爱人和我之间，存在着一股十足的肉体化学作用。",
        "我相信自己所不被爱人了解的部分，将会伤害到他 / 她。",
        "真诚的爱情首先必须具备一段时间的关心和喜欢。",
        "在选择恋爱对象之前，我会先试着仔细地去规划我的生活。",
        "当我的失恋时，我会变得十分沮丧，甚至会有自杀的念头产生。",
        "与其让我的爱人承受苦痛，宁愿由我自己来承受。",
        "我们在做爱时是十分激情且满足的。",
        "我会有一些时候避免我的两个爱人去查明对方。",
        "我和曾经拥有过爱情关系的人，仍能保持良好的友谊关系。",
        "爱上一个和自己生活背景相似的人是件最好的事。",
        "有时我会因为想到自己正身处于爱情之中，而兴奋得睡不着觉。",
        "除非我先让我的爱人比我先得到快乐，不然我不会感到快乐。",
        "我感到我的爱人和我是被彼此选定的。",
        "我可以相当容易且快速的遗忘自己的风流韵事。",
        "最佳的爱情产生于长久的友谊。",
        "对方如何看待我的家人，是选择恋爱对象时的一项主要考量。",
        "当我的爱人不再注意我时，我会感到浑身不适。",
        "我常常愿意牺牲自己的愿望来让我的爱人达成他 / 她所想要的。",
        "我的爱人和我形成肉体（或情绪）上彼此纠结的过程十分快速。",
        "如果我的爱人知道了某些我和别人做过的事，他 / 她将会觉得难过、苦恼。",
        "很难切确地说明我和我的爱人是在何时墬入爱河。",
        "对方是否可以成为一个好的父母，是选择伴侣的一个重要因素。",
        "当我在恋爱的时候，会很难集中注意力在其它事物上。",
        "我的任何东西，都可以让我的爱人依照他 / 她的挑选自行取用。",
        "我的爱人和我十分地了解彼此。",
        "如果我的爱人对我太过依赖，我会想做出稍许的退缩。",
        "爱情的确是一种深厚的友谊关系，而非一种神秘的情绪。",
        "对方如何看待我的职业，是选择伴侣时的考量之一。",
        "当我怀疑我的爱人正和某人在一起时，我会无法放松自己。",
        "即使我的爱人对我发怒，我依然全心全意、无条件的爱他 / 她。",
        "我的爱人十分符合我对外貌的理想标准。",
        "我享受着和数个不同的对象进行爱情游戏。",
        "我最满意的爱情关系是由友谊发展而来。",
        "在和任何人相爱之前，我会先描绘出假使我们拥有孩子时，对方和我的基因兼容性如何。",
        "当我的爱人有一段时间忽略我时，我会做出一些蠢事去引起他 / 她的注意。",
        "为了我的爱人的利益，我愿意忍受任何事情。"
    ];

    // 3. 欢迎页
    timeline.push({
        type: jsPsychHtmlButtonResponse,
        stimulus: `
            <div style="padding:40px 0;">
                <h1 style="color:#fff; font-weight:300;">爱情态度光谱</h1>
                <p style="color:#666; margin-top:20px;">42道共鸣题 · 解析你的潜意识恋爱波段</p>
                <div style="margin-top:40px; font-size:12px; color:#444;">建议佩戴耳机 · 保持内心诚实</div>
            </div>
        `,
        choices: ['开始播放']
    });

    // 4. 构建题目（每页6题）
    const itemsPerPage = 6;
    const totalPages = Math.ceil(questions.length / itemsPerPage);

    for (let i = 0; i < totalPages; i++) {
        let pageQuestions = [];
        for (let j = 0; j < itemsPerPage; j++) {
            let index = i * itemsPerPage + j;
            if (index < questions.length) {
                pageQuestions.push({
                    prompt: `<strong style="color:#dd001b;">${index + 1}.</strong> ${questions[index]}`,
                    name: `Q${index}`, 
                    labels: scale,
                    required: true
                });
            }
        }

        timeline.push({
            type: jsPsychSurveyLikert,
            questions: pageQuestions,
            scale_width: 500,
            button_label: i === totalPages - 1 ? '生成报告' : '下一章',
            data: { my_tag: 'survey_data' }, // 关键：添加自定义标签以便抓取数据
            on_start: function() {
                jsPsych.setProgressBar(i / totalPages);
            }
        });
    }

    // 5. 维度定义
    const types = [
        { id: 0, name: "星河浪漫诗人", en: "ROMANTIC", desc: "你相信一眼万年，爱是身体与灵魂瞬间的共振。像一场盛大的烟火，追求极致的璀璨与心动。" },
        { id: 1, name: "自由捕风者", en: "GAME", desc: "爱是一场充满博弈的游戏。你像风一样自由，享受当下的快乐，却不愿被承诺的枷锁困住翅膀。" },
        { id: 2, name: "暖冬温茶旅人", en: "COMPANION", desc: "细水长流是你的爱情信条。比起轰轰烈烈，你更相信深厚友谊升华而来的默契与陪伴。" },
        { id: 3, name: "精密筑梦师", en: "REALISTIC", desc: "你是理性的规划家。在交付真心前，你会仔细考量未来。你相信匹配的条件是共同构筑城堡的基石。" },
        { id: 4, name: "炽热燃魂者", en: "POSSESSIVE", desc: "你的爱如烈火般炽热，带有强烈的占有欲。对方的每个眼神都能牵动你的神经，爱让你狂喜也让你煎熬。" },
        { id: 5, name: "深海守望者", en: "DEVOTION", desc: "你拥有无私的奉献精神。爱是默默的付出与成全，你像深海一样包容，愿意为了对方的快乐牺牲自己。" }
    ];

    // 6. 结果反馈页
    const feedback = {
        type: jsPsychHtmlButtonResponse,
        stimulus: function() {
            // --- A. 数据抓取与清洗 ---
            // 使用自定义标签 'my_tag' 过滤，确保只获取问卷数据
            const rawData = jsPsych.data.get().filter({my_tag: 'survey_data'}).values();
            let responses = {};
            rawData.forEach(trial => Object.assign(responses, trial.response));

            // --- B. 维度计算 ---
            let scores = [0, 0, 0, 0, 0, 0]; // 对应6个维度
            
            // 遍历42题
            for (let k = 0; k < 42; k++) {
                let key = `Q${k}`;
                // 容错处理：如果数据没取到，默认为2(没意见)，防止计算NaN
                let val = (responses[key] !== undefined) ? responses[key] + 1 : 3; 
                let dim = k % 6; // 0=浪漫, 1=游戏...
                scores[dim] += val;
            }

            // --- C. 结果排序 (关键修改：解决复合型问题) ---
            // 将分数与维度信息绑定，然后排序
            let ranked = scores.map((score, index) => {
                return { score: score, type: types[index] };
            }).sort((a, b) => b.score - a.score);

            // 无论是否同分，取第一名为“主导人格”
            let winner = ranked[0];
            let runnerUp = ranked[1];

            // 判断是否有显著的副人格 (比如分数仅差1-2分，或者同分)
            let isTie = (winner.score === runnerUp.score);
            let hasSecondary = (winner.score - runnerUp.score) <= 3; // 差值3分以内算副人格

            // --- D. 生成HTML ---
            let secondaryHtml = "";
            if (hasSecondary) {
                secondaryHtml = `
                    <div class="secondary-type">
                        * 你的 <strong>${runnerUp.type.name}</strong> 特质也十分显著（得分 ${runnerUp.score}），
                        这让你的爱情风格更加${isTie ? "多元且平衡" : "丰富立体"}。
                    </div>
                `;
            }

            // 保存数据给图表
            window.chartData = scores;

            return `
                <div class="result-box">
                    <div class="tag">云村心理实验室 · 测评报告</div>
                    <div class="main-title">${winner.type.name}</div>
                    <div class="sub-title">${winner.type.en}</div>
                    
                    <div style="position: relative; height:300px; width:100%; max-width:500px; margin:0 auto;">
                        <canvas id="radarChart"></canvas>
                    </div>

                    <div class="desc-card">
                        <div class="desc-text">
                            ${winner.type.desc}
                        </div>
                        ${secondaryHtml}
                    </div>
                    
                    <div style="margin-top:20px; font-size:12px; color:#555;">
                        截图保存 · 去听首情歌吧
                    </div>
                </div>
            `;
        },
        choices: ['结束测验'],
        on_load: function() {
            jsPsych.setProgressBar(1);
            
            // 绘制雷达图
            const ctx = document.getElementById('radarChart').getContext('2d');
            new Chart(ctx, {
                type: 'radar',
                data: {
                    labels: ['浪漫', '游戏', '同伴', '现实', '占有', '奉献'],
                    datasets: [{
                        label: '维度得分',
                        data: window.chartData,
                        backgroundColor: 'rgba(221, 0, 27, 0.25)',
                        borderColor: '#dd001b',
                        borderWidth: 2,
                        pointBackgroundColor: '#dd001b',
                        pointBorderColor: '#fff',
                        pointRadius: 3
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        r: {
                            angleLines: { color: 'rgba(255, 255, 255, 0.05)' },
                            grid: { color: 'rgba(255, 255, 255, 0.05)' },
                            pointLabels: { color: '#ccc', font: { size: 12 } },
                            ticks: { display: false, backdropColor: 'transparent' },
                            suggestedMin: 5,
                            suggestedMax: 35
                        }
                    },
                    plugins: { legend: { display: false } }
                }
            });
        }
    };
    timeline.push(feedback);

    // 7. 运行
    jsPsych.run(timeline);
</script>
</html>
